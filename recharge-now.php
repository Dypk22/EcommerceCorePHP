<?php require 'connection.php'; $userId=$_SESSION['USER_ID']; $payment_id=rand(11111111111111,99999999999999); date_default_timezone_set("Asia/Kolkata"); $added_on=date('Y-m-d H:i:s'); if($_GET['type']=='prepaid_recharge'){$MobileNumber=$_GET['MobileNumber']; $type=strtolower($_GET['rechPlan']); $operator=$_GET['operator']; $operator_type=$_GET['rechOperatorType']; $operatorCircle=$_GET['operatorCircle']; $rechAmount=$_GET['amount']; $couponCode=(isset($_SESSION['coupon']))?strtolower($_SESSION['coupon']):''; $validity=$_GET['validity'].' days'; if ($operator=='airtel'){$operator='bharti airtel ltd';}elseif ($operator=='reliance jio'){$operator='reliance jio infocomm ltd (rjil)';}elseif ($operator=='reliance communications'){$operator='reliance communications ltd (rcom)';}elseif ($operator=='vodafone idea'){$operator='vodafone idea ltd (formerly vodafone india ltd)';}elseif ($operator=='aircel'){$operator='aircel cellular ltd';}elseif ($operator=='bsnl'){$operator='bharat sanchar nigam ltd (bsnl)';}else{$operator='mahanagar telephone nigam ltd (mtnl)';}mysqli_query($con, "INSERT INTO `mobile_recharge_orders` (`user_id`, `mobile`, `operator_type`, `amount`, `operator`, `operator_circle`, `validity`, `plan`, `coupon`,`status`,`transaction_id`, `payment_method`, `operator_reference_id`, `operator_status`, `date`) VALUES ('$userId','$MobileNumber', '$operator_type', '$rechAmount', '$operator', '$operatorCircle', '$validity', '$type', '$couponCode', 'success', '$payment_id', 'wallet', 'not-available', 'pending', '$added_on')"); $_SESSION['order_id']=mysqli_insert_id($con);}if($_GET['type']=='dth_recharge'){$DTHoperator=strtolower(strip_tags(mysqli_real_escape_string($con,$_GET['dthoperator']))); $cardNumber=strtolower(strip_tags(mysqli_real_escape_string($con,$_GET['cardnumber']))); $rechargeAmount=strtolower(strip_tags(mysqli_real_escape_string($con,$_GET['amount']))); $coupon_code=(isset($_SESSION['coupon']))?strtolower($_SESSION['coupon']):''; $rechAmount=$rechargeAmount; mysqli_query($con, "INSERT INTO `dth_recharge_orders` (`user_id`, `dth_number`, `dth_operator`, `amount`, `coupon`, `status`, `transaction_id`, `payment_method`, `operator_reference_id`, `operator_status`, `date`) VALUES ('$userId', '$cardNumber', '$DTHoperator', '$rechargeAmount', '$coupon_code', 'pending', '$payment_id', 'wallet', 'not-available', 'pending', '$added_on')"); $_SESSION['order_id']=mysqli_insert_id($con);}$wallet_detail=mysqli_fetch_assoc(mysqli_query($con,"select * from wallet where user_id='$userId' order by `wallet`.`id` desc limit 1")); $bal=$wallet_detail['updated_balance']; $cb=$wallet_detail['updated_cashback']; $discount=(isset($_SESSION['coupon_discount']))?$_SESSION['coupon_discount']:0; $newcb=$cb+$discount; $newBal=$discount+$bal+$cb; $netcb=0; $finbal=($cb+$bal)-$rechAmount; $updBal=$bal-$rechAmount; if ($rechAmount>=$bal){$updBal=0; $netcb=($bal+$cb)-$rechAmount;}else{if ($rechAmount<$bal){$netcb=$cb;}else{$updBal=0; $netcb=($cb+$bal)-$rechAmount;}}$fcb=($netcb!=0)?$netcb:0; $payment_id_tmp=rand(11111,99999).'-'.rand(11111,99999).'-'.rand(11111,99999).'-'.rand(11111,99999); mysqli_query($con, "INSERT INTO `wallet` (`user_id`, `type`, `amount`, `transaction_id`, `payment_id`, `status`, `updated_balance`, `cashback`, `updated_cashback`, `coupon_code`, `added_on`) VALUES ('$userId', 'paid-from-wallet', '$rechAmount', '$payment_id', '$payment_id_tmp', 'success', '$updBal', '0', '$netcb', '', '$added_on')"); $_SESSION['txn_sucess']='success'; if (isset($_SESSION['coupon'])){$cbamount=$_SESSION['coupon_discount']; $netcb+=$cbamount; $payment_id_tmp=rand(11111,99999).'-'.rand(11111,99999).'-'.rand(11111,99999).'-'.rand(11111,99999); mysqli_query($con, "INSERT INTO `wallet` (`user_id`, `type`, `amount`, `transaction_id`, `payment_id`, `status`, `updated_balance`, `cashback`, `updated_cashback`, `coupon_code`, `added_on`) VALUES ('$userId', 'cashback-credited', '$cbamount', '$payment_id', '$payment_id_tmp', 'success', '$updBal', '$cbamount', '$netcb', '$couponCode', '$added_on')");}$finbal=$netcb+$updBal; mysqli_query($con, "UPDATE `users` SET `wallet`='$finbal' WHERE `users`.`id`='$userId'");if($_GET['type']=='prepaid_recharge'){unset($_SESSION['selected_operator']); unset($_SESSION['rechOperator']); header('Location:'.SITE_PATH.'recharge-status');}if($_GET['type']=='dth_recharge'){header('Location:'.SITE_PATH.'dth-recharge-status');}?>